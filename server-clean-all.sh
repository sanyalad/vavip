#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ü–û–õ–ù–û–ô –æ—á–∏—Å—Ç–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –æ—Ç –í–°–ï–• Docker –ø—Ä–æ–µ–∫—Ç–æ–≤
# –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —É–¥–∞–ª–∏—Ç –í–°–ï Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –æ–±—Ä–∞–∑—ã, volumes, —Å–µ—Ç–∏!
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./server-clean-all.sh

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo "=============================================="
echo -e "${RED}‚ö†Ô∏è  –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –°–ï–†–í–ï–†–ê${NC}"
echo "=============================================="
echo ""
echo -e "${RED}–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —É–¥–∞–ª–∏—Ç:${NC}"
echo "  - –í–°–ï Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–≤–∫–ª—é—á–∞—è –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ!)"
echo "  - –í–°–ï Docker –æ–±—Ä–∞–∑—ã"
echo "  - –í–°–ï Docker volumes (–≤–∫–ª—é—á–∞—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!)"
echo "  - –í–°–ï Docker —Å–µ—Ç–∏"
echo "  - –í–°–ï Docker build cache"
echo ""
echo -e "${RED}‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í—Å–µ Docker –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ!${NC}"
echo ""

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ
echo -e "${CYAN}üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ Docker:${NC}"
docker system df
echo ""

CONTAINERS=$(docker ps -a -q | wc -l)
IMAGES=$(docker images -q | wc -l)
VOLUMES=$(docker volume ls -q | wc -l)
NETWORKS=$(docker network ls --filter type=custom -q | wc -l)

if [ "$CONTAINERS" -gt 0 ] || [ "$IMAGES" -gt 0 ] || [ "$VOLUMES" -gt 0 ]; then
    echo -e "${CYAN}–ù–∞–π–¥–µ–Ω–æ:${NC}"
    echo "  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: $CONTAINERS"
    echo "  –û–±—Ä–∞–∑–æ–≤: $IMAGES"
    echo "  Volumes: $VOLUMES"
    echo "  –°–µ—Ç–µ–π: $NETWORKS"
    echo ""
fi

# –°–ø–∏—Å–æ–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
RUNNING=$(docker ps -q)
if [ -n "$RUNNING" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –ó–∞–ø—É—â–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:${NC}"
    docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"
    echo ""
fi

# –ü–µ—Ä–≤–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
echo -e "${YELLOW}–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï Docker —Ä–µ—Å—É—Ä—Å—ã? (y/N):${NC}"
read -r CONFIRM1
if [[ ! $CONFIRM1 =~ ^[Yy]$ ]]; then
    echo -e "${GREEN}‚úì –û—á–∏—Å—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞${NC}"
    exit 0
fi

echo ""

# –í—Ç–æ—Ä–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
echo -e "${RED}=============================================="
echo "‚ö†Ô∏è  –ü–û–°–õ–ï–î–ù–ï–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï!"
echo "=============================================="
echo -e "${NC}"
echo -e "${RED}–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –£–î–ê–õ–ò–¢–¨ –í–°–ï Docker —Ä–µ—Å—É—Ä—Å—ã?${NC}"
echo -e "${YELLOW}–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û!${NC}"
echo ""
echo "–í–≤–µ–¥–∏—Ç–µ 'CLEAN ALL' (–∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏) –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:"
read -r FINAL_CONFIRM

if [ "$FINAL_CONFIRM" != "CLEAN ALL" ]; then
    echo -e "${GREEN}‚úì –û—á–∏—Å—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞${NC}"
    exit 0
fi

echo ""
echo -e "${CYAN}üßπ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É...${NC}"
echo ""

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo -e "${CYAN}üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...${NC}"
docker stop $(docker ps -aq) 2>/dev/null || true
echo -e "${GREEN}‚úì –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"
echo ""

# –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo -e "${CYAN}üóëÔ∏è  –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...${NC}"
docker rm $(docker ps -aq) 2>/dev/null || true
echo -e "${GREEN}‚úì –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã${NC}"
echo ""

# –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–∑—ã
echo -e "${CYAN}üóëÔ∏è  –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–∑—ã...${NC}"
docker rmi $(docker images -q) -f 2>/dev/null || true
echo -e "${GREEN}‚úì –í—Å–µ –æ–±—Ä–∞–∑—ã —É–¥–∞–ª–µ–Ω—ã${NC}"
echo ""

# –£–¥–∞–ª—è–µ–º –≤—Å–µ volumes
echo -e "${CYAN}üóëÔ∏è  –£–¥–∞–ª—è–µ–º –≤—Å–µ volumes (–≤–∫–ª—é—á–∞—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!)...${NC}"
docker volume rm $(docker volume ls -q) 2>/dev/null || true
echo -e "${GREEN}‚úì –í—Å–µ volumes —É–¥–∞–ª–µ–Ω—ã${NC}"
echo ""

# –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–µ—Ç–∏ (–∫—Ä–æ–º–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö)
echo -e "${CYAN}üóëÔ∏è  –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–µ—Ç–∏...${NC}"
docker network prune -f 2>/dev/null || true
echo -e "${GREEN}‚úì –í—Å–µ —Å–µ—Ç–∏ —É–¥–∞–ª–µ–Ω—ã${NC}"
echo ""

# –û—á–∏—â–∞–µ–º build cache
echo -e "${CYAN}üßπ –û—á–∏—â–∞–µ–º build cache...${NC}"
docker builder prune -a -f 2>/dev/null || true
echo -e "${GREEN}‚úì Build cache –æ—á–∏—â–µ–Ω${NC}"
echo ""

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã
echo -e "${CYAN}üßπ –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É —Å–∏—Å—Ç–µ–º—ã...${NC}"
docker system prune -a -f --volumes 2>/dev/null || true
echo -e "${GREEN}‚úì –°–∏—Å—Ç–µ–º–∞ –æ—á–∏—â–µ–Ω–∞${NC}"
echo ""

echo "=============================================="
echo -e "${GREEN}‚úÖ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
echo "=============================================="
echo ""
echo -e "${CYAN}üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ Docker –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:${NC}"
docker system df
echo ""

